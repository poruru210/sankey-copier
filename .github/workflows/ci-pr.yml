# Pull Request Validation Pipeline
name: CI Pull Request

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      force_web:
        description: "Force all Web UI checks"
        required: false
        default: false
        type: boolean
      force_rust:
        description: "Force relay-server Linux tests"
        required: false
        default: false
        type: boolean
      force_rust_dll:
        description: "Force mt-bridge DLL builds"
        required: false
        default: false
        type: boolean
      force_mql:
        description: "Force MQL compiles"
        required: false
        default: false
        type: boolean
      force_vercel:
        description: "Deploy preview even when Web UI unchanged"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write
  deployments: write

concurrency:
  group: ci-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  version-info:
    name: Generate Version Information
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ steps.compute_version.outputs.package_version }}
      file_version: ${{ steps.compute_version.outputs.file_version }}
      build_info: ${{ steps.compute_version.outputs.build_info }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version information
        id: compute_version
        run: |
          TAG=$(git describe --tags --abbrev=0 --match "v[0-9]*" 2>/dev/null || echo "v0.1.0")
          VERSION=${TAG#v}
          BUILD=$(git rev-list --count HEAD)
          HASH=$(git rev-parse --short HEAD)
          PACKAGE_VERSION="$VERSION"
          FILE_VERSION="$VERSION.$BUILD"
          BUILD_INFO="$VERSION+build.$BUILD.$HASH"
          echo "package_version=$PACKAGE_VERSION" >> "$GITHUB_OUTPUT"
          echo "file_version=$FILE_VERSION" >> "$GITHUB_OUTPUT"
          echo "build_info=$BUILD_INFO" >> "$GITHUB_OUTPUT"
          cat <<EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          â•‘ Version Information
          â•‘ PACKAGE_VERSION: $PACKAGE_VERSION
          â•‘ FILE_VERSION:    $FILE_VERSION
          â•‘ BUILD_INFO:      $BUILD_INFO
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF

  paths-filter:
    name: Detect Changed Components
    runs-on: ubuntu-latest
    needs: version-info
    outputs:
      web: ${{ steps.filter.outputs.web }}
      rust: ${{ steps.filter.outputs.rust }}
      mql: ${{ steps.filter.outputs.mql }}
      tray: ${{ steps.filter.outputs.tray }}
      desktop: ${{ steps.filter.outputs.desktop }}
      installer: ${{ steps.filter.outputs.installer }}
      docs: ${{ steps.filter.outputs.docs }}
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute path filters
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            web:
              - 'web-ui/**'
              - '.github/workflows/deploy-vercel.yml'
            rust:
              - 'relay-server/**'
              - 'mt-bridge/**'
              - 'tray-app/**'
              - '.github/workflows/build-rust.yml'
            tray:
              - 'tray-app/**'
            mql:
              - 'mt-advisors/**'
              - '.github/workflows/build-mql.yml'
            desktop:
              - 'desktop-app/**'
            installer:
              - 'installer/**'
              - '.github/workflows/build-installer.yml'
            docs:
              - 'docs/**'
            infra:
              - '.github/actions/**'
              - '.github/workflows/**'

  manual-flags:
    name: Resolve Manual Overrides
    runs-on: ubuntu-latest
    outputs:
      force_web: ${{ steps.flags.outputs.force_web }}
      force_rust: ${{ steps.flags.outputs.force_rust }}
      force_rust_dll: ${{ steps.flags.outputs.force_rust_dll }}
      force_mql: ${{ steps.flags.outputs.force_mql }}
      force_vercel: ${{ steps.flags.outputs.force_vercel }}
    steps:
      - name: Compute override flags
        id: flags
        run: |
          FORCE_WEB=false
          FORCE_RUST=false
          FORCE_RUST_DLL=false
          FORCE_MQL=false
          FORCE_VERCEL=false

          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            FORCE_WEB=$(jq -r '.inputs.force_web // "false"' "$GITHUB_EVENT_PATH")
            FORCE_RUST=$(jq -r '.inputs.force_rust // "false"' "$GITHUB_EVENT_PATH")
            FORCE_RUST_DLL=$(jq -r '.inputs.force_rust_dll // "false"' "$GITHUB_EVENT_PATH")
            FORCE_MQL=$(jq -r '.inputs.force_mql // "false"' "$GITHUB_EVENT_PATH")
            FORCE_VERCEL=$(jq -r '.inputs.force_vercel // "false"' "$GITHUB_EVENT_PATH")
          fi

          {
            echo "force_web=$FORCE_WEB"
            echo "force_rust=$FORCE_RUST"
            echo "force_rust_dll=$FORCE_RUST_DLL"
            echo "force_mql=$FORCE_MQL"
            echo "force_vercel=$FORCE_VERCEL"
          } >> "$GITHUB_OUTPUT"

  event-context:
    name: Collect Event Context
    runs-on: ubuntu-latest
    outputs:
      is_pr: ${{ steps.collect.outputs.is_pr }}
      pr_number: ${{ steps.collect.outputs.pr_number }}
      pr_is_draft: ${{ steps.collect.outputs.pr_is_draft }}
      pr_is_from_fork: ${{ steps.collect.outputs.pr_is_from_fork }}
    steps:
      - name: Compute event metadata
        id: collect
        run: |
          IS_PR=false
          PR_NUMBER=""
          PR_IS_DRAFT=false
          PR_IS_FROM_FORK=false

          if jq -e '.pull_request' "$GITHUB_EVENT_PATH" > /dev/null; then
            IS_PR=true
            PR_NUMBER=$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")
            PR_IS_DRAFT=$(jq -r '.pull_request.draft // false' "$GITHUB_EVENT_PATH")
            PR_IS_FROM_FORK=$(jq -r '.pull_request.head.repo.fork // false' "$GITHUB_EVENT_PATH")
          fi

          {
            echo "is_pr=$IS_PR"
            echo "pr_number=$PR_NUMBER"
            echo "pr_is_draft=$PR_IS_DRAFT"
            echo "pr_is_from_fork=$PR_IS_FROM_FORK"
          } >> "$GITHUB_OUTPUT"

  # --- Optimized Jobs ---

  web-checks:
    name: Web UI Checks
    runs-on: ubuntu-latest
    needs: [paths-filter, manual-flags]
    if: ${{ needs.paths-filter.outputs.web == 'true' || needs.manual-flags.outputs.force_web == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: web-ui
        run: bun install --frozen-lockfile

      - name: Check Linting
        working-directory: web-ui
        run: bun run lint

      - name: Check Types
        working-directory: web-ui
        run: bun run tsc --noEmit

  rust-linux-check:
    name: Rust Check (Linux)
    runs-on: ubuntu-latest
    needs: [version-info, paths-filter, manual-flags]
    if: ${{ needs.paths-filter.outputs.rust == 'true' || needs.manual-flags.outputs.force_rust == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            relay-server

      - name: Check formatting and linting
        working-directory: relay-server
        run: |
          cargo fmt --all -- --check
          cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests with coverage (E2E included)
        working-directory: relay-server
        run: |
          # Run tests once and generate all reports
          cargo llvm-cov --workspace --all-features --codecov --output-path codecov.json
          cargo llvm-cov report --html --output-dir coverage-report
          cargo llvm-cov report --lcov --output-path lcov.info

          # Extract coverage for summary
          COVERAGE=$(cargo llvm-cov report 2>&1 | grep "TOTAL" | awk '{print $10}')
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Coverage**: \`${COVERAGE}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full HTML report available in workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: relay-server/coverage-report/
          retention-days: 30

      - name: Upload coverage LCOV file
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: relay-server/lcov.info
          retention-days: 30

  rust-windows-check:
    name: Rust Check (Windows)
    runs-on: windows-latest
    needs: [version-info, paths-filter, manual-flags]
    if: ${{ needs.paths-filter.outputs.rust == 'true' || needs.manual-flags.outputs.force_rust == 'true' }}
    env:
      PACKAGE_VERSION: ${{ needs.version-info.outputs.package_version }}
      FILE_VERSION: ${{ needs.version-info.outputs.file_version }}
      BUILD_INFO: ${{ needs.version-info.outputs.build_info }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: i686-pc-windows-msvc, x86_64-pc-windows-msvc

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2

      # 1. MT-Bridge (DLL) - Check compilation for both 32-bit and 64-bit
      # Actual linking is important for DLLs, so we use build (Debug is fast)
      - name: Build DLL (32-bit)
        run: cargo build --package sankey-copier-mt-bridge --target i686-pc-windows-msvc

      - name: Build DLL (64-bit)
        run: cargo build --package sankey-copier-mt-bridge --target x86_64-pc-windows-msvc

      # 2. Run Windows-specific tests (Registry, etc)
      - name: Test (Windows)
        run: cargo test --workspace --all-features

      # 3. Check Tray App (excluded from workspace, manual check needed)
      - name: Check Tray App
        working-directory: tray-app
        run: cargo check

  mql-build:
    name: Compile MQL Advisors
    needs: [version-info, paths-filter, manual-flags]
    if: ${{ needs.paths-filter.outputs.mql == 'true' || needs.manual-flags.outputs.force_mql == 'true' }}
    uses: ./.github/workflows/build-mql.yml
    with:
      package_version: ${{ needs.version-info.outputs.file_version }}
      build_target: mql
    secrets: inherit

  # web-lint and web-typecheck replaced by web-checks above

  #  deploy-preview:
  #    name: Deploy Vercel Preview
  #    needs:
  #      - paths-filter
  #      - manual-flags
  #      - event-context
  #      - web-lint
  #      - web-typecheck
  #    if: ${{ fromJSON(needs.event-context.outputs.is_pr) && !fromJSON(needs.event-context.outputs.pr_is_draft) && !fromJSON(needs.event-context.outputs.pr_is_from_fork) && (needs.paths-filter.outputs.web == 'true' || needs.manual-flags.outputs.force_vercel == 'true') }}
  #    uses: ./.github/workflows/deploy-vercel.yml
  #    with:
  #      deployment_target: preview
  #      is_pr: ${{ fromJSON(needs.event-context.outputs.is_pr) }}
  #      pr_number: ${{ needs.event-context.outputs.pr_number }}
  #      pr_is_from_fork: ${{ fromJSON(needs.event-context.outputs.pr_is_from_fork) }}
  #    secrets: inherit

  summarize:
    name: Publish Workflow Summary
    runs-on: ubuntu-latest
    needs:
      - version-info
      - paths-filter
      - manual-flags
    if: always()
    steps:
      - name: Build summary
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## CI Pull Request Summary

          **Version**: `${{ needs.version-info.outputs.package_version }}` (`${{ needs.version-info.outputs.build_info }}`)

          | Component | Changed? | Forced? |
          | --- | --- | --- |
          | Web | `${{ needs.paths-filter.outputs.web }}` | `${{ needs.manual-flags.outputs.force_web }}` |
          | Rust | `${{ needs.paths-filter.outputs.rust }}` | `${{ needs.manual-flags.outputs.force_rust }}` |
          | Tray | `${{ needs.paths-filter.outputs.tray }}` | `${{ needs.manual-flags.outputs.force_rust }}` |
          | mt-bridge DLL | `${{ needs.paths-filter.outputs.rust }}` | `${{ needs.manual-flags.outputs.force_rust_dll }}` |
          | MQL | `${{ needs.paths-filter.outputs.mql }}` | `${{ needs.manual-flags.outputs.force_mql }}` |
          | Preview Deploy | `${{ needs.paths-filter.outputs.web }}` | `${{ needs.manual-flags.outputs.force_vercel }}` |

          _Note: Individual job statuses remain visible under the **Checks** tab. Use the table above to confirm which components were targeted in this run._
          EOF
