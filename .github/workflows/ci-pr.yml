# Pull Request Validation Pipeline
name: CI Pull Request

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, ready_for_review ]
  workflow_dispatch:
    inputs:
      force_web:
        description: 'Force all Web UI checks'
        required: false
        default: false
        type: boolean
      force_rust:
        description: 'Force relay-server Linux tests'
        required: false
        default: false
        type: boolean
      force_rust_dll:
        description: 'Force mt-bridge DLL builds'
        required: false
        default: false
        type: boolean
      force_mql:
        description: 'Force MQL compiles'
        required: false
        default: false
        type: boolean
      force_vercel:
        description: 'Deploy preview even when Web UI unchanged'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ci-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  version-info:
    name: Generate Version Information
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ steps.compute_version.outputs.package_version }}
      file_version: ${{ steps.compute_version.outputs.file_version }}
      build_info: ${{ steps.compute_version.outputs.build_info }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version information
        id: compute_version
        run: |
          TAG=$(git describe --tags --abbrev=0 --match "v[0-9]*" 2>/dev/null || echo "v0.1.0")
          VERSION=${TAG#v}
          BUILD=$(git rev-list --count HEAD)
          HASH=$(git rev-parse --short HEAD)
          PACKAGE_VERSION="$VERSION"
          FILE_VERSION="$VERSION.$BUILD"
          BUILD_INFO="$VERSION+build.$BUILD.$HASH"
          echo "package_version=$PACKAGE_VERSION" >> "$GITHUB_OUTPUT"
          echo "file_version=$FILE_VERSION" >> "$GITHUB_OUTPUT"
          echo "build_info=$BUILD_INFO" >> "$GITHUB_OUTPUT"
          cat <<EOF
          ╔═══════════════════════════════════════════
          ║ Version Information
          ║ PACKAGE_VERSION: $PACKAGE_VERSION
          ║ FILE_VERSION:    $FILE_VERSION
          ║ BUILD_INFO:      $BUILD_INFO
          ╚═══════════════════════════════════════════
          EOF

  paths-filter:
    name: Detect Changed Components
    runs-on: ubuntu-latest
    needs: version-info
    outputs:
      web: ${{ steps.filter.outputs.web }}
      rust: ${{ steps.filter.outputs.rust }}
      mql: ${{ steps.filter.outputs.mql }}
      desktop: ${{ steps.filter.outputs.desktop }}
      installer: ${{ steps.filter.outputs.installer }}
      docs: ${{ steps.filter.outputs.docs }}
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute path filters
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            web:
              - 'web-ui/**'
              - '.github/workflows/deploy-vercel.yml'
            rust:
              - 'relay-server/**'
              - 'mt-bridge/**'
              - 'tray-app/**'
              - '.github/workflows/build-rust.yml'
            mql:
              - 'mt-advisors/**'
              - '.github/workflows/build-mql.yml'
            desktop:
              - 'desktop-app/**'
            installer:
              - 'installer/**'
              - '.github/workflows/build-installer.yml'
            docs:
              - 'docs/**'
            infra:
              - '.github/actions/**'
              - '.github/workflows/**'

  rust-tests:
    name: Relay Server Tests & Clippy
    runs-on: ubuntu-latest
    needs: [version-info, paths-filter]
    if: ${{ needs.paths-filter.outputs.rust == 'true' || github.event.inputs.force_rust == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            relay-server

      - name: Run fmt/clippy/tests (relay-server)
        working-directory: relay-server
        run: |
          cargo fmt --all -- --check
          cargo clippy --all-targets --all-features -- -D warnings
          cargo test --workspace --all-features

  rust-dll:
    name: Build mt-bridge DLLs
    needs: [version-info, paths-filter]
    if: ${{ needs.paths-filter.outputs.rust == 'true' || github.event.inputs.force_rust_dll == 'true' }}
    uses: ./.github/workflows/build-rust.yml
    with:
      package_version: ${{ needs.version-info.outputs.package_version }}
      file_version: ${{ needs.version-info.outputs.file_version }}
      build_target: rust-dll

  mql-build:
    name: Compile MQL Advisors
    needs: [version-info, paths-filter]
    if: ${{ needs.paths-filter.outputs.mql == 'true' || github.event.inputs.force_mql == 'true' }}
    uses: ./.github/workflows/build-mql.yml
    with:
      package_version: ${{ needs.version-info.outputs.package_version }}
      build_target: mql
    secrets: inherit

  web-lint:
    name: Web UI Lint
    runs-on: ubuntu-latest
    needs: paths-filter
    if: ${{ needs.paths-filter.outputs.web == 'true' || github.event.inputs.force_web == 'true' || github.event.inputs.force_vercel == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with pnpm
        uses: ./.github/actions/setup-node
        with:
          working-directory: web-ui

      - name: Install dependencies
        working-directory: web-ui
        run: pnpm install --frozen-lockfile

      - name: Run lint
        working-directory: web-ui
        run: pnpm lint

  web-typecheck:
    name: Web UI Type Check
    runs-on: ubuntu-latest
    needs: paths-filter
    if: ${{ needs.paths-filter.outputs.web == 'true' || github.event.inputs.force_web == 'true' || github.event.inputs.force_vercel == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with pnpm
        uses: ./.github/actions/setup-node
        with:
          working-directory: web-ui

      - name: Install dependencies
        working-directory: web-ui
        run: pnpm install --frozen-lockfile

      - name: Type check via tsc
        working-directory: web-ui
        run: pnpm exec tsc --noEmit

  web-e2e:
    name: Web UI Playwright E2E
    runs-on: ubuntu-latest
    needs: [paths-filter, web-lint, web-typecheck]
    if: ${{ (needs.paths-filter.outputs.web == 'true' || github.event.inputs.force_web == 'true' || github.event.inputs.force_vercel == 'true') && (github.event_name != 'pull_request' || github.event.pull_request.draft != true) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with pnpm
        uses: ./.github/actions/setup-node
        with:
          working-directory: web-ui

      - name: Install dependencies
        working-directory: web-ui
        run: pnpm install --frozen-lockfile

      - name: Build application
        working-directory: web-ui
        env:
          NEXT_BUILD_MODE: standalone
        run: pnpm build

      - name: Install Playwright browsers
        working-directory: web-ui
        run: pnpm exec playwright install --with-deps

      - name: Start Next server
        working-directory: web-ui
        run: |
          pnpm start &
          echo $! > server.pid

      - name: Wait for server
        working-directory: web-ui
        run: npx wait-on@7 http://127.0.0.1:8080

      - name: Run Playwright tests
        working-directory: web-ui
        env:
          CI: true
        run: pnpm test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: web-ui/playwright-report
          if-no-files-found: ignore
          retention-days: 7

      - name: Stop Next server
        if: always()
        working-directory: web-ui
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

  summarize:
    name: Publish Workflow Summary
    runs-on: ubuntu-latest
    needs:
      - version-info
      - paths-filter
    if: always()
    steps:
      - name: Build summary
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## CI Pull Request Summary

          **Version**: `${{ needs.version-info.outputs.package_version }}` (`${{ needs.version-info.outputs.build_info }}`)

          | Component | Changed? | Forced? |
          | --- | --- | --- |
          | Web | `${{ needs.paths-filter.outputs.web }}` | `${{ github.event.inputs.force_web == 'true' }}` |
          | Rust | `${{ needs.paths-filter.outputs.rust }}` | `${{ github.event.inputs.force_rust == 'true' }}` |
          | mt-bridge DLL | `${{ needs.paths-filter.outputs.rust }}` | `${{ github.event.inputs.force_rust_dll == 'true' }}` |
          | MQL | `${{ needs.paths-filter.outputs.mql }}` | `${{ github.event.inputs.force_mql == 'true' }}` |
          | Preview Deploy | `${{ needs.paths-filter.outputs.web }}` | `${{ github.event.inputs.force_vercel == 'true' }}` |

          _Note: Individual job statuses remain visible under the **Checks** tab. Use the table above to confirm which components were targeted in this run._
          EOF

  deploy-preview:
    name: Deploy Preview to Vercel
    needs:
      - summarize
      - version-info
      - paths-filter
      - web-lint
      - web-typecheck
    if: ${{ github.event_name == 'pull_request' && (needs.paths-filter.outputs.web == 'true' || github.event.inputs.force_vercel == 'true') }}
    uses: ./.github/workflows/deploy-vercel.yml
    with:
      deployment_target: preview
      is_pr: true
      pr_number: ${{ github.event.pull_request.number }}
      pr_is_from_fork: ${{ github.event.pull_request.head.repo.fork }}
    secrets: inherit
