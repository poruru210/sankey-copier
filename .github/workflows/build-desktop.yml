name: Build Desktop App

on:
  workflow_call:
    inputs:
      version:
        description: 'Version number for the build'
        required: true
        type: string
    outputs:
      artifact-name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.build-desktop.outputs.artifact-name }}

jobs:
  build-desktop:
    runs-on: windows-latest
    outputs:
      artifact-name: sankey-copier-desktop

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Web UI artifact
        uses: actions/download-artifact@v4
        with:
          name: sankey-copier-web-ui
          path: desktop-app/src-tauri/resources/web-ui

      - name: Verify Web UI artifact structure
        run: |
          Write-Host "Verifying Web UI artifact structure..."
          Get-ChildItem -Path desktop-app/src-tauri/resources/web-ui -Recurse | ForEach-Object { Write-Host $_.FullName }
          if (Test-Path "desktop-app/src-tauri/resources/web-ui/.next/standalone/server.js") {
            Write-Host "‚úì Found server.js"
          } elseif (Test-Path "desktop-app/src-tauri/resources/web-ui/out/index.html") {
            Write-Host "‚úì Found static export out/index.html"
          } else {
            Write-Host "‚ö†Ô∏è No recognized web build found yet - proceeding to copy attempt (will fail later if missing)."
          }
        shell: pwsh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            desktop-app/src-tauri/target/
          key: ${{ runner.os }}-cargo-desktop-${{ hashFiles('desktop-app/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-desktop-
            ${{ runner.os }}-cargo-

      - name: Prepare Tauri dist (copy web build -> src-tauri/dist)
        working-directory: desktop-app/src-tauri
        run: |
          # We're already in desktop-app/src-tauri, so use relative paths
          $src = "resources\web-ui"
          $dist = "dist"

          Write-Host "Creating $dist..."
          New-Item -ItemType Directory -Path $dist -Force | Out-Null

          # Next.js standalone (server + assets)
          if (Test-Path "$src\.next\standalone") {
            Write-Host "Copying Next.js standalone to dist..."

            # Copy all contents from standalone directory (including node_modules)
            Write-Host "Copying server.js, package.json, and node_modules..."
            Copy-Item -Path "$src\.next\standalone\*" -Destination $dist -Recurse -Force

            # Ensure .next/static is also copied (needed for assets)
            if (Test-Path "$src\.next\static") {
              Write-Host "Copying .next/static to dist/.next/static"
              $staticDest = Join-Path $dist ".next\static"
              New-Item -ItemType Directory -Path $staticDest -Force | Out-Null
              Copy-Item -Path "$src\.next\static\*" -Destination $staticDest -Recurse -Force
            }

            # Copy public directory if exists
            if (Test-Path "$src\public") {
              Write-Host "Copying public directory..."
              Copy-Item -Path "$src\public" -Destination $dist -Recurse -Force
            }

            # Verify critical files exist
            if (Test-Path "$dist\server.js") {
              Write-Host "‚úì server.js found"
            } else {
              Write-Host "‚ùå server.js NOT found"
            }

            if (Test-Path "$dist\node_modules") {
              $moduleCount = (Get-ChildItem "$dist\node_modules" -Directory).Count
              Write-Host "‚úì node_modules found with $moduleCount packages"
            } else {
              Write-Host "‚ùå node_modules NOT found"
            }

            if (Test-Path "$dist\package.json") {
              Write-Host "‚úì package.json found"
            } else {
              Write-Host "‚ùå package.json NOT found"
            }
          }
          # Static export (out/)
          elseif (Test-Path "$src\out") {
            Write-Host "Copying static export (out) to dist..."
            Copy-Item -Path "$src\out\*" -Destination $dist -Recurse -Force

            # Copy public directory if exists
            if (Test-Path "$src\public") {
              Write-Host "Copying public directory..."
              Copy-Item -Path "$src\public\*" -Destination $dist -Recurse -Force
            }
          }
          else {
            Write-Host "ERROR: No recognized web build found under $src"
            Get-ChildItem -Path $src -Recurse -Depth 2 | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

          Write-Host "Summary of dist directory:"
          Write-Host "===================="
          Get-ChildItem -Path $dist -Directory | ForEach-Object { Write-Host "üìÅ $($_.Name)" }
          Get-ChildItem -Path $dist -File | ForEach-Object { Write-Host "üìÑ $($_.Name)" }
        shell: pwsh

      - name: Build Desktop App with Tauri Action
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: desktop-app/src-tauri
          tauriScript: cargo tauri
          args: --verbose

      - name: List build output
        run: |
          Write-Host "Listing desktop-app/src-tauri/target/release:"
          if (Test-Path "desktop-app/src-tauri/target/release") {
            Get-ChildItem -Path desktop-app/src-tauri/target/release -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
          }
          Write-Host "Listing desktop-app/src-tauri/target/release/bundle:"
          if (Test-Path "desktop-app/src-tauri/target/release/bundle") {
            Get-ChildItem -Path desktop-app/src-tauri/target/release/bundle -Recurse -Include *.exe, *.msi | ForEach-Object { Write-Host $_.FullName }
          }
        shell: pwsh

      - name: Upload Desktop App artifact
        uses: actions/upload-artifact@v4
        with:
          name: sankey-copier-desktop
          path: |
            desktop-app/src-tauri/target/release/sankey-copier-desktop.exe
            desktop-app/src-tauri/target/release/bundle/**/*.exe
            desktop-app/src-tauri/target/release/bundle/**/*.msi
          retention-days: 7