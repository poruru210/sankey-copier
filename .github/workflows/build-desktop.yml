name: Build Desktop App

on:
  workflow_call:
    inputs:
      version:
        description: 'Version number for the build'
        required: true
        type: string
    outputs:
      artifact-name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.build-desktop.outputs.artifact-name }}

jobs:
  build-desktop:
    runs-on: windows-latest
    outputs:
      artifact-name: sankey-copier-desktop

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Web UI artifact
        uses: actions/download-artifact@v4
        with:
          name: sankey-copier-web-ui
          path: desktop-app/src-tauri/resources/web-ui

      - name: Verify Web UI artifact structure
        run: |
          Write-Host "Verifying Web UI artifact structure..."
          Get-ChildItem -Path desktop-app/src-tauri/resources/web-ui -Recurse | ForEach-Object { Write-Host $_.FullName }
          if (Test-Path "desktop-app/src-tauri/resources/web-ui/.next/standalone/server.js") {
            Write-Host "✓ Found server.js"
          } elseif (Test-Path "desktop-app/src-tauri/resources/web-ui/out/index.html") {
            Write-Host "✓ Found static export out/index.html"
          } else {
            Write-Host "⚠️ No recognized web build found yet - proceeding to copy attempt (will fail later if missing)."
          }
        shell: pwsh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            desktop-app/src-tauri/target/
          key: ${{ runner.os }}-cargo-desktop-${{ hashFiles('desktop-app/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-desktop-
            ${{ runner.os }}-cargo-

      - name: Install Tauri CLI
        run: |
          # Check if Tauri CLI is already installed
          if (Get-Command cargo-tauri -ErrorAction SilentlyContinue) {
            Write-Host "Tauri CLI already installed"
            cargo tauri --version
          } else {
            Write-Host "Installing Tauri CLI..."
            cargo install tauri-cli --version "^2.0.0" --locked
            cargo tauri --version
          }
        shell: pwsh

      - name: Prepare Tauri dist (copy web build -> src-tauri/dist)
        working-directory: desktop-app/src-tauri
        run: |
          # We're already in desktop-app/src-tauri, so use relative paths
          $src = "resources\web-ui"
          $dist = "dist"

          Write-Host "Creating $dist..."
          New-Item -ItemType Directory -Path $dist -Force | Out-Null

          # Next.js standalone (server + assets)
          if (Test-Path "$src\.next\standalone") {
            Write-Host "Copying Next.js standalone to dist..."
            Copy-Item -Path "$src\.next\standalone\*" -Destination $dist -Recurse -Force
            if (Test-Path "$src\.next\static") {
              Write-Host "Copying .next/static to dist/.next/static"
              New-Item -ItemType Directory -Path (Join-Path $dist ".next\static") -Force | Out-Null
              Copy-Item -Path "$src\.next\static\*" -Destination (Join-Path $dist ".next\static") -Recurse -Force
            }
          }
          # Static export (out/)
          elseif (Test-Path "$src\out") {
            Write-Host "Copying static export (out) to dist..."
            Copy-Item -Path "$src\out\*" -Destination $dist -Recurse -Force
          }
          else {
            Write-Host "ERROR: No recognized web build found under $src"
            Get-ChildItem -Path $src -Recurse | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

          Write-Host "Contents of dist after copy:"
          Get-ChildItem -Path $dist -Recurse | ForEach-Object { Write-Host $_.FullName }
        shell: pwsh

      - name: Verify Cargo.toml location (debug)
        run: |
          Write-Host "Looking for Cargo.toml under desktop-app..."
          Get-ChildItem -Path desktop-app -Filter Cargo.toml -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
        shell: pwsh

      - name: Build Desktop App (cargo/tauri) in src-tauri
        working-directory: desktop-app/src-tauri
        run: |
          Write-Host "Running from $(Get-Location)"
          if (-not (Test-Path "Cargo.toml")) {
            Write-Host "❌ Cargo.toml not found in current working directory: $(Get-Location)"
            exit 1
          }

          # Verify dist directory contents
          Write-Host "Contents of dist directory before build:"
          if (Test-Path "dist") {
            Get-ChildItem -Path dist | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "dist directory not found!"
          }

          # Check for index.html or server.js in dist
          if (-not ((Test-Path "dist/index.html") -or (Test-Path "dist/server.js"))) {
            Write-Host "❌ Neither dist/index.html nor dist/server.js found - Web UI build missing!"
            Write-Host "Contents of dist directory:"
            Get-ChildItem -Path dist -Recurse | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

          # Clean and build with verbose output
          cargo clean
          $env:RUST_BACKTRACE = "full"
          cargo tauri build --verbose 2>&1 | Tee-Object -Variable buildOutput
          $exitCode = $LASTEXITCODE
          if ($exitCode -ne 0) {
            Write-Host "❌ Tauri build failed with exit code: $exitCode"
            Write-Host "Last 50 lines of build output:"
            $buildOutput | Select-Object -Last 50
            exit $exitCode
          }
        shell: pwsh

      - name: List build output
        run: |
          Write-Host "Listing desktop-app/src-tauri/target/release:" 
          Get-ChildItem -Path desktop-app/src-tauri/target/release -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
        shell: pwsh

      - name: Upload Desktop App artifact
        uses: actions/upload-artifact@v4
        with:
          name: sankey-copier-desktop
          path: |
            desktop-app/src-tauri/target/release/sankey-copier-desktop.exe
          retention-days: 7