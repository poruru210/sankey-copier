name: Build Desktop App

on:
  workflow_call:
    inputs:
      version:
        description: 'Version number for the build'
        required: true
        type: string
    outputs:
      artifact-name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.build-desktop.outputs.artifact-name }}

jobs:
  build-desktop:
    runs-on: windows-latest
    outputs:
      artifact-name: sankey-copier-desktop

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Build Web UI for Desktop
        working-directory: web-ui
        run: |
          Write-Host "Installing dependencies..."
          pnpm install --frozen-lockfile

          Write-Host "Building Web UI..."
          $env:NEXT_OUTPUT_MODE = "standalone"
          pnpm run build

          Write-Host "Verifying build output..."
          if (Test-Path ".next/standalone/server.js") {
            Write-Host "✓ Build successful - standalone server.js found"
          } elseif (Test-Path "out/index.html") {
            Write-Host "✓ Build successful - static export found"
          } else {
            Write-Host "⚠️ Standalone build not found, checking build output..."
            Get-ChildItem -Path .next -Directory | ForEach-Object { Write-Host $_.Name }
          }
        shell: pwsh

      - name: Copy Web UI to Tauri resources
        run: |
          $src = "web-ui"
          $dest = "desktop-app/src-tauri/resources/web-ui"

          Write-Host "Creating resources directory..."
          New-Item -ItemType Directory -Path $dest -Force | Out-Null

          Write-Host "Copying build output..."
          # Copy standalone build
          Copy-Item -Path "$src\.next" -Destination $dest -Recurse -Force
          # Copy public files if exists
          if (Test-Path "$src\public") {
            Copy-Item -Path "$src\public" -Destination $dest -Recurse -Force
          }

          Write-Host "Verification:"
          if (Test-Path "$dest\.next\standalone\server.js") {
            Write-Host "✓ server.js copied"
          }
          if (Test-Path "$dest\.next\standalone\node_modules") {
            $count = (Get-ChildItem "$dest\.next\standalone\node_modules" -Directory).Count
            Write-Host "✓ node_modules copied ($count packages)"
          }
        shell: pwsh

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            desktop-app/src-tauri/target/
          key: ${{ runner.os }}-cargo-desktop-${{ hashFiles('desktop-app/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-desktop-
            ${{ runner.os }}-cargo-

      - name: Prepare Tauri dist directory
        working-directory: desktop-app/src-tauri
        run: |
          $src = "resources\web-ui"
          $dist = "dist"

          Write-Host "Creating dist directory..."
          New-Item -ItemType Directory -Path $dist -Force | Out-Null

          # Copy Next.js standalone build to dist
          if (Test-Path "$src\.next\standalone") {
            Write-Host "Copying Next.js standalone build to dist..."

            # Copy all standalone content (includes node_modules)
            Copy-Item -Path "$src\.next\standalone\*" -Destination $dist -Recurse -Force

            # Copy static files
            if (Test-Path "$src\.next\static") {
              Write-Host "Copying static files..."
              $staticDest = Join-Path $dist ".next\static"
              New-Item -ItemType Directory -Path $staticDest -Force | Out-Null
              Copy-Item -Path "$src\.next\static\*" -Destination $staticDest -Recurse -Force
            }

            # Copy public directory
            if (Test-Path "$src\public") {
              Write-Host "Copying public directory..."
              Copy-Item -Path "$src\public" -Destination $dist -Recurse -Force
            }
          }
          else {
            Write-Host "ERROR: Standalone build not found at $src\.next\standalone"
            exit 1
          }

          Write-Host "`nVerifying dist directory:"
          Write-Host "========================"
          if (Test-Path "$dist\server.js") {
            Write-Host "✓ server.js"
          }
          if (Test-Path "$dist\package.json") {
            Write-Host "✓ package.json"
          }
          if (Test-Path "$dist\node_modules") {
            $count = (Get-ChildItem "$dist\node_modules" -Directory).Count
            Write-Host "✓ node_modules ($count packages)"
          }
          if (Test-Path "$dist\.next") {
            Write-Host "✓ .next directory"
          }
          if (Test-Path "$dist\public") {
            Write-Host "✓ public directory"
          }
        shell: pwsh

      - name: Build Desktop App with Tauri Action
        uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: desktop-app/src-tauri
          distPath: ../src-tauri/dist

      - name: List build output
        run: |
          Write-Host "Listing desktop-app/src-tauri/target/release:"
          if (Test-Path "desktop-app/src-tauri/target/release") {
            Get-ChildItem -Path desktop-app/src-tauri/target/release -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
          }
          Write-Host "Listing desktop-app/src-tauri/target/release/bundle:"
          if (Test-Path "desktop-app/src-tauri/target/release/bundle") {
            Get-ChildItem -Path desktop-app/src-tauri/target/release/bundle -Recurse -Include *.exe, *.msi | ForEach-Object { Write-Host $_.FullName }
          }
        shell: pwsh

      - name: Upload Desktop App artifact
        uses: actions/upload-artifact@v4
        with:
          name: sankey-copier-desktop
          path: |
            desktop-app/src-tauri/target/release/sankey-copier-desktop.exe
            desktop-app/src-tauri/target/release/bundle/**/*.exe
            desktop-app/src-tauri/target/release/bundle/**/*.msi
          retention-days: 7