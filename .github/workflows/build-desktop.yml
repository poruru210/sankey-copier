name: Build Desktop App

on:
  workflow_call:
    inputs:
      version:
        description: 'Version number for the build'
        required: true
        type: string
    outputs:
      artifact-name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.build-desktop.outputs.artifact-name }}

jobs:
  build-desktop:
    runs-on: windows-latest
    outputs:
      artifact-name: sankey-copier-desktop

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # Setup Rust toolchain
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # Cache dependencies
      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: |
            web-ui/node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('web-ui/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            desktop-app/src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('desktop-app/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # Build Web UI
      - name: Build Web UI
        run: |
          cd web-ui

          Write-Host "Installing dependencies..." -ForegroundColor Cyan
          pnpm install --frozen-lockfile

          Write-Host "Building Next.js application..." -ForegroundColor Cyan
          pnpm run build

          # Verify build output
          if (!(Test-Path ".next/standalone")) {
            Write-Host "Build failed: standalone directory not found" -ForegroundColor Red
            exit 1
          }

          Write-Host "Build completed successfully" -ForegroundColor Green
        shell: pwsh

      # Prepare dist for Tauri
      - name: Prepare dist for Tauri
        run: |
          Write-Host "Preparing dist directory for Tauri..." -ForegroundColor Cyan

          # Clean and create dist directory
          $distPath = "desktop-app/src-tauri/dist"
          if (Test-Path $distPath) {
            Remove-Item -Path $distPath -Recurse -Force
          }
          New-Item -ItemType Directory -Path $distPath -Force | Out-Null

          # Copy standalone build
          Write-Host "Copying standalone build..." -ForegroundColor Yellow
          Copy-Item -Path "web-ui/.next/standalone/*" -Destination $distPath -Recurse -Force

          # Copy static assets
          Write-Host "Copying static assets..." -ForegroundColor Yellow
          $staticSource = "web-ui/.next/static"
          if (Test-Path $staticSource) {
            $staticDest = "$distPath/.next/static"
            New-Item -ItemType Directory -Path $staticDest -Force | Out-Null
            Copy-Item -Path "$staticSource/*" -Destination $staticDest -Recurse -Force
          }

          # Copy public files
          Write-Host "Copying public files..." -ForegroundColor Yellow
          $publicSource = "web-ui/public"
          if (Test-Path $publicSource) {
            Copy-Item -Path $publicSource -Destination $distPath -Recurse -Force
          }

          # Verify critical files
          Write-Host "`nVerifying dist contents:" -ForegroundColor Cyan
          $checks = @(
            @{Path = "$distPath/server.js"; Name = "server.js"},
            @{Path = "$distPath/package.json"; Name = "package.json"},
            @{Path = "$distPath/node_modules"; Name = "node_modules"},
            @{Path = "$distPath/.next"; Name = ".next directory"},
            @{Path = "$distPath/public"; Name = "public directory"}
          )

          $allGood = $true
          foreach ($check in $checks) {
            if (Test-Path $check.Path) {
              Write-Host "  ✓ $($check.Name)" -ForegroundColor Green
            } else {
              Write-Host "  ✗ $($check.Name) - MISSING" -ForegroundColor Red
              $allGood = $false
            }
          }

          if (!$allGood) {
            Write-Host "`nSome required files are missing!" -ForegroundColor Red
            exit 1
          }

          Write-Host "`nDist preparation complete!" -ForegroundColor Green
        shell: pwsh

      # Build Tauri application
      - name: Build Tauri application
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: desktop-app/src-tauri
          tauriScript: cargo tauri

      # Upload artifacts
      - name: Upload Desktop App artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sankey-copier-desktop
          path: |
            desktop-app/src-tauri/target/release/bundle/**/*.exe
            desktop-app/src-tauri/target/release/bundle/**/*.msi
          retention-days: 7
          if-no-files-found: error