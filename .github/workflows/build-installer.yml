# Build Windows Installer
# Reusable workflow for packaging all components into an installer
name: Build Windows Installer

on:
  workflow_call:
    inputs:
      package_version:
        description: 'Package version (e.g., 0.1.0)'
        required: true
        type: string
      file_version:
        description: 'File version (e.g., 0.1.0.123)'
        required: true
        type: string
      build_info:
        description: 'Full build information string'
        required: true
        type: string
      create_release:
        description: 'Whether to create a GitHub release (for tags)'
        required: false
        type: boolean
        default: false

jobs:
  build-installer:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: build-artifacts

      - name: Cache Inno Setup
        id: cache-inno
        uses: actions/cache@v4
        with:
          path: C:\Program Files (x86)\Inno Setup 6
          key: innosetup-6.3.3

      - name: Install Inno Setup
        if: steps.cache-inno.outputs.cache-hit != 'true'
        run: choco install innosetup -y

      - name: Add Inno Setup to PATH
        run: |
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Cache NSSM
        id: cache-nssm
        uses: actions/cache@v4
        with:
          path: installer/resources/nssm.exe
          key: nssm-2.24

      - name: Download and setup NSSM
        if: steps.cache-nssm.outputs.cache-hit != 'true'
        run: |
          Invoke-WebRequest -Uri "https://nssm.cc/release/nssm-2.24.zip" -OutFile "nssm.zip"
          Expand-Archive -Path "nssm.zip" -DestinationPath "."
          New-Item -ItemType Directory -Force -Path "installer/resources"
          Copy-Item "nssm-2.24/win64/nssm.exe" -Destination "installer/resources/nssm.exe"
          Remove-Item "nssm.zip"
          Remove-Item "nssm-2.24" -Recurse

      - name: Update version in project files
        run: |
          $version = "${{ inputs.package_version }}"
          Write-Host "Updating version to: $version" -ForegroundColor Cyan

          # Update Cargo.toml files
          $cargoFiles = @(
            "relay-server/Cargo.toml",
            "mt-bridge/Cargo.toml",
            "tray-app/Cargo.toml"
          )

          foreach ($file in $cargoFiles) {
            $content = Get-Content $file -Raw
            $content = $content -replace 'version = "[^"]*"', "version = `"$version`""
            Set-Content $file -Value $content -NoNewline
            Write-Host "✓ Updated $file" -ForegroundColor Green
          }

          # Update package.json
          $packageJson = Get-Content "web-ui/package.json" -Raw | ConvertFrom-Json
          $packageJson.version = $version
          $packageJson | ConvertTo-Json -Depth 100 | Set-Content "web-ui/package.json"
          Write-Host "✓ Updated web-ui/package.json" -ForegroundColor Green

      - name: Merge artifacts into dist/
        run: |
          Write-Host "Merging build artifacts into dist/..." -ForegroundColor Cyan

          # List downloaded artifacts
          Write-Host "Downloaded artifacts structure:"
          Get-ChildItem "build-artifacts" -Recurse | Select-Object -First 50 | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }

          # Create dist directory
          New-Item -ItemType Directory -Force -Path "dist"

          # Merge all artifacts (each artifact outputs to dist/ structure)
          $artifactDirs = @(
            "build-artifacts/sankey-copier-server",
            "build-artifacts/sankey-copier-desktop",
            "build-artifacts/sankey-copier-tray",
            "build-artifacts/sankey-copier-dll",
            "build-artifacts/sankey-copier-mql-MT4",
            "build-artifacts/sankey-copier-mql-MT5"
          )

          foreach ($dir in $artifactDirs) {
            if (Test-Path $dir) {
              Write-Host "Merging: $dir"
              Copy-Item "$dir\*" -Destination "dist\" -Recurse -Force
            } else {
              Write-Host "⚠️ Not found: $dir"
            }
          }

          # Copy app.ico to dist/
          Copy-Item "app.ico" -Destination "dist\" -Force
          Write-Host "✓ Copied app.ico"

          # Copy NSSM to dist/
          Copy-Item "installer/resources/nssm.exe" -Destination "dist\" -Force
          Write-Host "✓ Copied nssm.exe"

          Write-Host ""
          Write-Host "Final dist/ structure:"
          Get-ChildItem "dist" -Recurse | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }

          Write-Host "✓ Artifacts merged" -ForegroundColor Green

      - name: Verify build artifacts
        run: |
          $artifacts = @(
            "dist/sankey-copier-server.exe",
            "dist/sankey-copier-desktop.exe",
            "dist/sankey-copier-tray.exe",
            "dist/config.toml",
            "dist/app.ico",
            "dist/nssm.exe",
            "dist/mt-advisors/MT4/Libraries/sankey_copier_zmq.dll",
            "dist/mt-advisors/MT5/Libraries/sankey_copier_zmq.dll"
          )

          foreach ($artifact in $artifacts) {
            if (-not (Test-Path $artifact)) {
              Write-Error "Missing artifact: $artifact"
              exit 1
            }
            Write-Host "✓ Found: $artifact" -ForegroundColor Green
          }

          # Optional: MQL compiled files
          if (Test-Path "dist/mt-advisors/MT4/Experts/*.ex4") {
            Write-Host "✓ Found: MT4 Expert Advisors" -ForegroundColor Green
          } else {
            Write-Host "⚠️ MT4 Expert Advisors not found (optional)"
          }

          if (Test-Path "dist/mt-advisors/MT5/Experts/*.ex5") {
            Write-Host "✓ Found: MT5 Expert Advisors" -ForegroundColor Green
          } else {
            Write-Host "⚠️ MT5 Expert Advisors not found (optional)"
          }

      - name: Compile installer with Inno Setup
        run: |
          $version = "${{ inputs.package_version }}"
          $fileVersion = "${{ inputs.file_version }}"
          $buildInfo = "${{ inputs.build_info }}"

          Write-Host "Compiling installer with version information:" -ForegroundColor Cyan
          Write-Host "  Package Version: $version" -ForegroundColor Cyan
          Write-Host "  File Version:    $fileVersion" -ForegroundColor Cyan
          Write-Host "  Build Info:      $buildInfo" -ForegroundColor Cyan

          # Check if setup.iss exists
          if (-not (Test-Path "installer/setup.iss")) {
            Write-Host "❌ setup.iss not found" -ForegroundColor Red
            exit 1
          }

          # Save output to log file for complete capture
          $logFile = "installer/inno-setup.log"
          Write-Host "Running Inno Setup compiler..." -ForegroundColor Cyan

          # Run compiler and capture both stdout and stderr
          & iscc /DMyAppVersion=$version /DMyFileVersion=$fileVersion /DMyBuildInfo=$buildInfo installer/setup.iss 2>&1 | Tee-Object -FilePath $logFile
          $exitCode = $LASTEXITCODE

          if ($exitCode -ne 0) {
            Write-Host ""
            Write-Host "❌ Inno Setup compilation failed with exit code: $exitCode" -ForegroundColor Red
            Write-Host "Full log saved to: $logFile" -ForegroundColor Yellow

            # Display last 100 lines of log
            Write-Host ""
            Write-Host "=== Last 100 lines of compilation log ===" -ForegroundColor Yellow
            Get-Content $logFile -Tail 100

            exit $exitCode
          }

          Write-Host "✓ Installer compiled successfully" -ForegroundColor Green

      - name: Verify installer output
        run: |
          Write-Host "Checking for installer output files..." -ForegroundColor Cyan

          if (Test-Path "installer/Output") {
            Write-Host "✓ Output directory exists" -ForegroundColor Green
            $exeFiles = Get-ChildItem "installer/Output/*.exe" -ErrorAction SilentlyContinue
            if ($exeFiles) {
              Write-Host "✓ Found installer files:" -ForegroundColor Green
              $exeFiles | ForEach-Object {
                $sizeKB = [math]::Round($_.Length / 1KB, 2)
                Write-Host "  - $($_.Name) ($sizeKB KB)"
              }
            } else {
              Write-Host "❌ No .exe files found in installer/Output/" -ForegroundColor Red
              Write-Host "Directory contents:"
              Get-ChildItem "installer/Output" | ForEach-Object {
                Write-Host "  - $($_.Name)"
              }
              exit 1
            }
          } else {
            Write-Host "❌ installer/Output directory does not exist" -ForegroundColor Red
            Write-Host "Current directory: $(Get-Location)"
            Write-Host "Installer directory contents:"
            Get-ChildItem "installer" | ForEach-Object {
              Write-Host "  - $($_.Name)"
            }
            exit 1
          }

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: sankey-copier-installer-${{ inputs.package_version }}
          path: installer/Output/*.exe
          retention-days: 90

      - name: Create GitHub Release
        if: ${{ inputs.create_release }}
        uses: softprops/action-gh-release@v2
        with:
          files: installer/Output/*.exe
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Version ${{ inputs.package_version }}

            Build Information: `${{ inputs.build_info }}`

            ### Installation
            Download the installer and run it to install SANKEY Copier on your Windows system.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
