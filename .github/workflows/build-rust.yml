# Build Rust Components (DLL, Server, Tray App)
# Reusable workflow for building all Rust-based components
name: Build Rust Components

on:
  workflow_call:
    inputs:
      package_version:
        description: 'Package version (e.g., 0.1.0)'
        required: true
        type: string
      file_version:
        description: 'File version (e.g., 0.1.0.123)'
        required: true
        type: string
      build_target:
        description: 'Build target selection'
        required: false
        type: string
        default: 'all'

jobs:
  build-rust-dll:
    name: Build Rust ZeroMQ DLL
    runs-on: windows-latest
    if: ${{ inputs.build_target == 'all' || inputs.build_target == 'rust-dll' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: i686-pc-windows-msvc, x86_64-pc-windows-msvc
          workspace: mt-bridge

      - name: Run tests
        working-directory: mt-bridge
        run: cargo test --lib

      - name: Build 32-bit DLL (MT4用)
        working-directory: mt-bridge
        env:
          PACKAGE_VERSION: ${{ inputs.package_version }}
          FILE_VERSION: ${{ inputs.file_version }}
        run: |
          echo "Building with PACKAGE_VERSION=${{ inputs.package_version }}"
          echo "Building with FILE_VERSION=${{ inputs.file_version }}"
          cargo build --release --target i686-pc-windows-msvc

      - name: Build 64-bit DLL (MT5用)
        working-directory: mt-bridge
        env:
          PACKAGE_VERSION: ${{ inputs.package_version }}
          FILE_VERSION: ${{ inputs.file_version }}
        run: |
          echo "Building with PACKAGE_VERSION=${{ inputs.package_version }}"
          echo "Building with FILE_VERSION=${{ inputs.file_version }}"
          cargo build --release --target x86_64-pc-windows-msvc

      - name: List built files (debug)
        run: |
          Write-Host "=== Listing MT4 (32-bit) build output ===" -ForegroundColor Cyan
          if (Test-Path "target\i686-pc-windows-msvc\release") {
            Get-ChildItem "target\i686-pc-windows-msvc\release" -Filter *.dll | ForEach-Object {
              Write-Host "  Found DLL: $($_.Name) ($([math]::Round($_.Length / 1KB, 2)) KB)"
            }
          } else {
            Write-Host "  Directory does not exist!" -ForegroundColor Red
          }

          Write-Host "=== Listing MT5 (64-bit) build output ===" -ForegroundColor Cyan
          if (Test-Path "target\x86_64-pc-windows-msvc\release") {
            Get-ChildItem "target\x86_64-pc-windows-msvc\release" -Filter *.dll | ForEach-Object {
              Write-Host "  Found DLL: $($_.Name) ($([math]::Round($_.Length / 1KB, 2)) KB)"
            }
          } else {
            Write-Host "  Directory does not exist!" -ForegroundColor Red
          }

      - name: Prepare DLL artifacts
        run: |
          # Output to dist/ structure for unified artifact layout
          mkdir -p dist/mt-advisors/MT4/Libraries
          mkdir -p dist/mt-advisors/MT5/Libraries
          copy target\i686-pc-windows-msvc\release\sankey_copier_zmq.dll dist\mt-advisors\MT4\Libraries\
          copy target\x86_64-pc-windows-msvc\release\sankey_copier_zmq.dll dist\mt-advisors\MT5\Libraries\

      - name: Upload DLL artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sankey-copier-dll
          path: dist/
          retention-days: 1

  build-relay-server:
    name: Build Relay Server
    runs-on: windows-latest
    if: ${{ inputs.build_target == 'all' || inputs.build_target == 'relay-server' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: relay-server

      - name: Run tests
        working-directory: relay-server
        run: |
          cargo test --lib
          cargo test --test config_distribution_test
          cargo test --test performance_benchmark_test

      - name: Build server
        working-directory: relay-server
        env:
          PACKAGE_VERSION: ${{ inputs.package_version }}
          FILE_VERSION: ${{ inputs.file_version }}
        run: |
          echo "Building with PACKAGE_VERSION=${{ inputs.package_version }}"
          echo "Building with FILE_VERSION=${{ inputs.file_version }}"
          cargo build --release

      - name: Prepare server artifacts
        run: |
          # Output to dist/ structure - binary name is now sankey-copier-server.exe (from Cargo.toml)
          mkdir -p dist
          copy target\release\sankey-copier-server.exe dist\
          copy config.toml dist\

      - name: Upload server artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sankey-copier-server
          path: dist/
          retention-days: 1

  build-tray-app:
    name: Build Tray Application
    runs-on: windows-latest
    if: ${{ inputs.build_target == 'all' || inputs.build_target == 'tray-app' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: tray-app

      - name: Build Tray Application
        working-directory: tray-app
        env:
          PACKAGE_VERSION: ${{ inputs.package_version }}
          FILE_VERSION: ${{ inputs.file_version }}
        run: |
          echo "Building with PACKAGE_VERSION=${{ inputs.package_version }}"
          echo "Building with FILE_VERSION=${{ inputs.file_version }}"
          cargo build --release

      - name: Prepare Tray Application artifacts
        run: |
          # Output to dist/ structure
          mkdir -p dist
          copy tray-app\target\release\sankey-copier-tray.exe dist\

      - name: Upload Tray Application artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sankey-copier-tray
          path: dist/
          retention-days: 1
